// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ======================================================
// [1] 조직/거래처 계층 구조
// ======================================================

model Business {
  id           Int      @id @default(autoincrement())
  businessName String   @unique 
  bizNumber    String?  
  ownerName    String?  
  
  clients      Client[]    // SalesChannel -> Client
  suppliers    Supplier[]
  warehouses   Warehouse[]
}

// Client (판매처/고객사)
model Client {
  id            Int      @id @default(autoincrement())
  businessId    Int
  business      Business @relation(fields: [businessId], references: [id])
  
  name          String   // 예: 쿠팡, 네이버, 자사몰
  code          String?  
  excelMapping  Json?    // 업로드 엑셀 양식 설정
  
  // [운송장 회신 양식]
  waybillFormat Json?    // 예: { "주문번호": "clientOrder.clientOrderNo", ... }

  orders        ClientOrder[]
  mappings      ClientProductMapping[]
}

model Supplier {
  id           Int      @id @default(autoincrement())
  businessId   Int
  business     Business @relation(fields: [businessId], references: [id])
  
  name         String   // 예: 김씨공장
  email        String?  
  orderFormat  Json?    // 발주서 양식 설정

  products     SupplierProduct[]
  orders       SupplierOrder[]
}

model Warehouse {
  id           Int      @id @default(autoincrement())
  businessId   Int
  business     Business @relation(fields: [businessId], references: [id])
  
  name         String   // 예: 용인창고
  location     String?  
  outputFormat Json?    // 송장 양식 설정

  stocks       WarehouseStock[]
  
  // [NEW] 매핑 및 주문 연결 (역방향 관계)
  targetedMappings ClientProductMapping[] 
  assignedOrders   RoubizOrder[]
}

// ======================================================
// [2] 상품 (Product)
// ======================================================

model RoubizProduct {
  id               Int      @id @default(autoincrement())
  roubizCode       String   @unique 
  name             String   
  standardCost     Decimal? 
  isSet            Boolean  @default(false)
  status           String   @default("ACTIVE")
  
  roubizOrders     RoubizOrder[]
  clientMappings   ClientProductMapping[]
  supplierProducts SupplierProduct[]
  warehouseStocks  WarehouseStock[]
  
  parentBundles    ProductBundle[] @relation("ParentProduct")
  childBundles     ProductBundle[] @relation("ChildProduct")
  
  supplierOrderItems SupplierOrderItem[]
}

model ProductBundle {
  id              Int           @id @default(autoincrement())
  parentProductId Int           
  parentProduct   RoubizProduct @relation("ParentProduct", fields: [parentProductId], references: [id])
  childProductId  Int           
  childProduct    RoubizProduct @relation("ChildProduct", fields: [childProductId], references: [id])
  quantity        Int           
  @@unique([parentProductId, childProductId], name: "parentProductId_childProductId")
}

// ======================================================
// [3] 매핑 (Mapping)
// ======================================================

model ClientProductMapping {
  id                Int           @id @default(autoincrement())
  clientId          Int           // clientId
  client            Client        @relation(fields: [clientId], references: [id])
  
  clientProductCode String        
  clientOptionName  String        
  
  roubizProductId   Int
  roubizProduct     RoubizProduct @relation(fields: [roubizProductId], references: [id])

  // [NEW] ★ 지정 출고처 (파생상품 개념 구현)
  // NULL: 본사 위탁 발주 (Supplier) - 기본값
  // 값 있음: 해당 창고 재고 우선 사용 (Warehouse)
  targetWarehouseId Int?          
  targetWarehouse   Warehouse?    @relation(fields: [targetWarehouseId], references: [id])
  
  @@unique([clientId, clientProductCode, clientOptionName], name: "client_product_option")
}

model SupplierProduct {
  id                  Int           @id @default(autoincrement())
  supplierId          Int           
  supplier            Supplier      @relation(fields: [supplierId], references: [id])
  
  roubizProductId     Int
  roubizProduct       RoubizProduct @relation(fields: [roubizProductId], references: [id])
  supplierProductCode String?       
  costPrice           Decimal       
  isPrimary           Boolean       @default(false) 
  
  @@unique([supplierId, roubizProductId], name: "supplierId_roubizProductId") 
}

// ======================================================
// [4] 주문 & 재고 흐름
// ======================================================

model ClientOrder {
  id             Int          @id @default(autoincrement())
  clientId       Int          // clientId
  client         Client       @relation(fields: [clientId], references: [id])
  
  clientOrderNo  String   
  productCode    String   
  optionName     String?  
  quantity       Int
  salesPrice     Decimal? 
  orderDate      DateTime 
  uploadedAt     DateTime     @default(now())
  isConverted    Boolean      @default(false) 
  roubizOrders   RoubizOrder[]
}

model RoubizOrder {
  id              Int           @id @default(autoincrement())
  clientOrderId   Int
  clientOrder     ClientOrder   @relation(fields: [clientOrderId], references: [id])
  roubizOrderNo   String        @unique 
  roubizProductId Int
  roubizProduct   RoubizProduct @relation(fields: [roubizProductId], references: [id])
  quantity        Int           
  status          String        @default("PENDING") // PENDING, READY, ORDERED, HOLD, SCHEDULED, SHIPPING
  
  // [NEW] ★ 이 주문 건은 어디서 처리할 것인가? (유연한 변경 가능)
  // 'SUPPLIER' (발주) / 'WAREHOUSE' (창고재고)
  sourceType      String        @default("SUPPLIER") 

  // [NEW] 창고 출고일 경우, 어느 창고인가?
  warehouseId     Int?          
  warehouse       Warehouse?    @relation(fields: [warehouseId], references: [id])

  // [발주 관제 필드]
  targetOrderDate DateTime?     @default(now())     
  holdReason      String?       
  isNextRound     Boolean       @default(false)     

  // [배송 정보]
  carrierId       Int?
  carrier         Carrier?      @relation(fields: [carrierId], references: [id])
  trackingNumber  String?       
  shippedAt       DateTime?     

  createdAt       DateTime      @default(now())
}

model SupplierOrder {
  id              Int           @id @default(autoincrement())
  supplierId      Int           
  supplier        Supplier      @relation(fields: [supplierId], references: [id])
  
  supplierOrderNo String        @unique 
  round           Int           @default(1) 
  status          String        @default("PENDING") 
  orderedAt       DateTime      @default(now())
  items           SupplierOrderItem[]
}

model SupplierOrderItem {
  id              Int           @id @default(autoincrement())
  supplierOrderId Int
  supplierOrder   SupplierOrder @relation(fields: [supplierOrderId], references: [id])
  roubizProductId Int           
  roubizProduct   RoubizProduct @relation(fields: [roubizProductId], references: [id])
  quantity        Int           
  unitCost        Decimal?      
}

model WarehouseStock {
  id              Int           @id @default(autoincrement())
  warehouseId     Int           
  warehouse       Warehouse     @relation(fields: [warehouseId], references: [id])
  
  roubizProductId Int
  roubizProduct   RoubizProduct @relation(fields: [roubizProductId], references: [id])
  quantity        Int           @default(0)

  @@unique([warehouseId, roubizProductId], name: "warehouse_product_stock")
}

// ======================================================
// [5] 택배사 및 배송 관리
// ======================================================

model Carrier {
  id        Int              @id @default(autoincrement())
  code      String           @unique 
  name      String           
  type      String           @default("PARCEL") 
  active    Boolean          @default(true)
  
  mappings  CarrierMapping[] 
  orders    RoubizOrder[]
}

model CarrierMapping {
  id        Int      @id @default(autoincrement())
  carrierId Int
  carrier   Carrier  @relation(fields: [carrierId], references: [id])
  alias     String   @unique 
}