// prisma/schema.prisma

// ------------------------------------------------------
// [설정] Prisma Client & DB 연결
// ------------------------------------------------------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ======================================================
// [1] 마스터 데이터 (Master Data)
// ======================================================

// 1-1. 통합 거래처 관리 (Client & Supplier)
model BusinessRole {
  id                 Int       @id @default(autoincrement())
  
  businessName       String    @unique // 거래처명 (예: 쿠팡, 김씨공장)
  
  // 구분 (다중 역할 가능)
  isClient           Boolean   @default(false) // 판매처 (매출처)
  isSupplier         Boolean   @default(false) // 공급처 (매입처)
  isWarehouse        Boolean   @default(false) // 창고
  
  // 속성
  clientGroup        String?   // 예: ST(위탁), DT(사입)
  recognitionKeyword String?   // 엑셀 인식 키워드
  description        String?

  // 관계
  clientOrders       ClientOrder[]
  supplierOrders     SupplierOrder[]
  clientMappings     ClientProductMapping[]
  supplierProducts   SupplierProduct[]
}

// 1-2. [핵심] 루비즈 기준 상품 (Roubiz Product)
model RoubizProduct {
  id               Int       @id @default(autoincrement())
  
  roubizCode       String    @unique // 예: R-A001 (우리 관리 코드)
  name             String    // 상품명
  
  standardCost     Decimal?  // 기준 원가
  isSet            Boolean   @default(false) // 세트 상품 여부
  status           String    @default("ACTIVE")
  
  // 관계
  roubizOrders     RoubizOrder[]
  clientMappings   ClientProductMapping[]
  supplierProducts SupplierProduct[]
  warehouseStocks  WarehouseStock[]

  // 세트 구성 관계 (BOM)
  parentBundles    ProductBundle[] @relation("ParentProduct")
  childBundles     ProductBundle[] @relation("ChildProduct")
  
  // 발주 품목
  supplierOrderItems SupplierOrderItem[]
}

// 1-3. [NEW] 세트 구성 정보 (Bill of Materials)
// 예: RB-10001(Parent) = R100081(Child) * 3개
model ProductBundle {
  id              Int           @id @default(autoincrement())
  
  parentProductId Int           // 세트 상품 ID
  parentProduct   RoubizProduct @relation("ParentProduct", fields: [parentProductId], references: [id])
  
  childProductId  Int           // 구성품(단품) ID
  childProduct    RoubizProduct @relation("ChildProduct", fields: [childProductId], references: [id])
  
  quantity        Int           // 구성 수량 (예: 3)
  
  @@unique([parentProductId, childProductId]) // 중복 방지
}

// ======================================================
// [2] 매핑 (Mapping) - 외부와 내부를 연결
// ======================================================

// 2-1. 고객사 상품 매핑 (Client -> Roubiz)
model ClientProductMapping {
  id               Int           @id @default(autoincrement())
  
  clientRoleId     Int
  clientRole       BusinessRole  @relation(fields: [clientRoleId], references: [id])
  
  clientProductCode String       // 고객사 상품코드
  clientOptionName  String       // 고객사 옵션명
  
  roubizProductId  Int
  roubizProduct    RoubizProduct @relation(fields: [roubizProductId], references: [id])
  
  @@unique([clientRoleId, clientProductCode, clientOptionName])
}

// 2-2. 공급처 상품 매핑 (Supplier -> Roubiz)
model SupplierProduct {
  id                  Int           @id @default(autoincrement())
  
  supplierId          Int
  supplier            BusinessRole  @relation(fields: [supplierId], references: [id])
  
  roubizProductId     Int
  roubizProduct       RoubizProduct @relation(fields: [roubizProductId], references: [id])
  
  supplierProductCode String?       // 공급처에서 쓰는 코드
  supplierProductName String?       // 공급처 상품명
  costPrice           Decimal       // 실제 매입 단가
  isPrimary           Boolean       @default(false) // 주거래처 여부
  
  // [추가] 같은 공급처 + 같은 상품 중복 등록 방지
  @@unique([supplierId, roubizProductId]) 
}

// ======================================================
// [3] 주문의 흐름 (Flow: Input -> Hub -> Output)
// ======================================================

// [STEP 1] 입력: Client Order (수주)
model ClientOrder {
  id               Int      @id @default(autoincrement())
  
  clientRoleId     Int
  clientRole       BusinessRole @relation(fields: [clientRoleId], references: [id])
  
  // 엑셀 원본 데이터
  clientOrderNo    String   // 판매처 주문번호
  productCode      String   // 엑셀상의 상품코드
  optionName       String?  // 엑셀상의 옵션명
  quantity         Int
  salesPrice       Decimal? // 판매가
  
  orderDate        DateTime // 주문일시
  uploadedAt       DateTime @default(now())

  // 상태 (루비즈 주문으로 변환되었는가?)
  isConverted      Boolean  @default(false) 

  // 연결
  roubizOrders     RoubizOrder[]
}

// [STEP 2] 허브: Roubiz Order (내부 처리)
model RoubizOrder {
  id               Int           @id @default(autoincrement())
  
  // 원본 연결
  clientOrderId    Int
  clientOrder      ClientOrder   @relation(fields: [clientOrderId], references: [id])
  
  // 우리 기준 (Roubiz)
  roubizOrderNo    String        @unique // 예: R-260207-0001
  
  roubizProductId  Int
  roubizProduct    RoubizProduct @relation(fields: [roubizProductId], references: [id])
  
  quantity         Int           // 고객 주문 수량
  status           String        @default("READY") 

  createdAt        DateTime      @default(now())
}

// [STEP 3] 출력: Supplier Order (발주)
model SupplierOrder {
  id               Int           @id @default(autoincrement())
  
  supplierId       Int
  supplier         BusinessRole  @relation(fields: [supplierId], references: [id])
  
  supplierOrderNo  String        @unique // 예: PO-VendorA-260207
  status           String        @default("PENDING") 
  
  orderedAt        DateTime      @default(now())
  
  // 이 발주서에 포함된 루비즈 주문들 (BOM 분해된 상태)
  items            SupplierOrderItem[]
}

// [NEW] 발주 상세 품목 (Unbundled Items)
model SupplierOrderItem {
  id              Int           @id @default(autoincrement())
  
  supplierOrderId Int
  supplierOrder   SupplierOrder @relation(fields: [supplierOrderId], references: [id])
  
  roubizProductId Int           // 여기는 무조건 "단품(Single)" ID가 들어옵니다.
  roubizProduct   RoubizProduct @relation(fields: [roubizProductId], references: [id])
  
  quantity        Int           // 발주 수량 (세트 주문수량 * 구성수량)
  unitCost        Decimal?      // 발주 단가
}

// ======================================================
// [4] 기타 (재고 등)
// ======================================================

model WarehouseStock {
  id              Int           @id @default(autoincrement())
  roubizProductId Int
  quantity        Int           @default(0)
  roubizProduct   RoubizProduct @relation(fields: [roubizProductId], references: [id])
}