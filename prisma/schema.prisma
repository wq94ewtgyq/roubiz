// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ======================================================
// [1] 조직/거래처 계층 구조
// ======================================================

model Business {
  id           Int      @id @default(autoincrement())
  businessName String   @unique 
  bizNumber    String?  
  ownerName    String?  
  
  salesChannels SalesChannel[]
  suppliers     Supplier[]
  warehouses    Warehouse[]
}

model SalesChannel {
  id           Int      @id @default(autoincrement())
  businessId   Int
  business     Business @relation(fields: [businessId], references: [id])
  
  name         String   // 예: 쿠팡, 네이버
  code         String?  
  excelMapping Json?    // 엑셀 양식 설정

  orders       ClientOrder[]
  mappings     ClientProductMapping[]
}

model Supplier {
  id           Int      @id @default(autoincrement())
  businessId   Int
  business     Business @relation(fields: [businessId], references: [id])
  
  name         String   // 예: 김씨공장
  email        String?  
  orderFormat  Json?    // 발주서 양식 설정

  products     SupplierProduct[]
  orders       SupplierOrder[]
}

model Warehouse {
  id           Int      @id @default(autoincrement())
  businessId   Int
  business     Business @relation(fields: [businessId], references: [id])
  
  name         String   // 예: 용인창고
  location     String?  
  outputFormat Json?    // 송장 양식 설정

  stocks       WarehouseStock[]
}

// ======================================================
// [2] 상품 (Product)
// ======================================================

model RoubizProduct {
  id               Int      @id @default(autoincrement())
  roubizCode       String   @unique 
  name             String   
  standardCost     Decimal? 
  isSet            Boolean  @default(false)
  status           String   @default("ACTIVE")
  
  roubizOrders     RoubizOrder[]
  clientMappings   ClientProductMapping[]
  supplierProducts SupplierProduct[]
  warehouseStocks  WarehouseStock[]
  
  parentBundles    ProductBundle[] @relation("ParentProduct")
  childBundles     ProductBundle[] @relation("ChildProduct")
  
  supplierOrderItems SupplierOrderItem[]
}

model ProductBundle {
  id              Int           @id @default(autoincrement())
  parentProductId Int           
  parentProduct   RoubizProduct @relation("ParentProduct", fields: [parentProductId], references: [id])
  childProductId  Int           
  childProduct    RoubizProduct @relation("ChildProduct", fields: [childProductId], references: [id])
  quantity        Int           
  @@unique([parentProductId, childProductId], name: "parentProductId_childProductId")
}

// ======================================================
// [3] 매핑 (Mapping)
// ======================================================

model ClientProductMapping {
  id                Int           @id @default(autoincrement())
  salesChannelId    Int           
  salesChannel      SalesChannel  @relation(fields: [salesChannelId], references: [id])
  
  clientProductCode String        
  clientOptionName  String        
  roubizProductId   Int
  roubizProduct     RoubizProduct @relation(fields: [roubizProductId], references: [id])
  
  @@unique([salesChannelId, clientProductCode, clientOptionName], name: "channel_product_option")
}

model SupplierProduct {
  id                  Int           @id @default(autoincrement())
  supplierId          Int           
  supplier            Supplier      @relation(fields: [supplierId], references: [id])
  
  roubizProductId     Int
  roubizProduct       RoubizProduct @relation(fields: [roubizProductId], references: [id])
  supplierProductCode String?       
  costPrice           Decimal       
  isPrimary           Boolean       @default(false) 
  
  @@unique([supplierId, roubizProductId], name: "supplierId_roubizProductId") 
}

// ======================================================
// [4] 주문 & 재고 흐름
// ======================================================

model ClientOrder {
  id             Int          @id @default(autoincrement())
  salesChannelId Int          
  salesChannel   SalesChannel @relation(fields: [salesChannelId], references: [id])
  
  clientOrderNo  String   
  productCode    String   
  optionName     String?  
  quantity       Int
  salesPrice     Decimal? 
  orderDate      DateTime 
  uploadedAt     DateTime     @default(now())
  isConverted    Boolean      @default(false) 
  roubizOrders   RoubizOrder[]
}

model RoubizOrder {
  id              Int           @id @default(autoincrement())
  clientOrderId   Int
  clientOrder     ClientOrder   @relation(fields: [clientOrderId], references: [id])
  roubizOrderNo   String        @unique 
  roubizProductId Int
  roubizProduct   RoubizProduct @relation(fields: [roubizProductId], references: [id])
  quantity        Int           
  status          String        @default("PENDING") // PENDING, READY, ORDERED, HOLD, SCHEDULED
  
  // [NEW] 발주 관제 필드
  targetOrderDate DateTime?     @default(now())     // 발주 예정일
  holdReason      String?       // 보류/지정일 사유
  isNextRound     Boolean       @default(false)     // 다음 차수 자동 복귀 여부

  createdAt       DateTime      @default(now())
}

model SupplierOrder {
  id              Int           @id @default(autoincrement())
  supplierId      Int           
  supplier        Supplier      @relation(fields: [supplierId], references: [id])
  
  supplierOrderNo String        @unique 
  round           Int           @default(1) 
  status          String        @default("PENDING") 
  orderedAt       DateTime      @default(now())
  items           SupplierOrderItem[]
}

model SupplierOrderItem {
  id              Int           @id @default(autoincrement())
  supplierOrderId Int
  supplierOrder   SupplierOrder @relation(fields: [supplierOrderId], references: [id])
  roubizProductId Int           
  roubizProduct   RoubizProduct @relation(fields: [roubizProductId], references: [id])
  quantity        Int           
  unitCost        Decimal?      
}

model WarehouseStock {
  id              Int           @id @default(autoincrement())
  warehouseId     Int           
  warehouse       Warehouse     @relation(fields: [warehouseId], references: [id])
  
  roubizProductId Int
  roubizProduct   RoubizProduct @relation(fields: [roubizProductId], references: [id])
  quantity        Int           @default(0)

  @@unique([warehouseId, roubizProductId], name: "warehouse_product_stock")
}