// ------------------------------------------------------
// [설정] Prisma Client & DB 연결
// ------------------------------------------------------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ======================================================
// [1] 마스터 데이터 (Master Data)
// ======================================================

// 1-1. 통합 거래처 관리 (Client & Supplier)
model BusinessRole {
  id                  Int      @id @default(autoincrement())
  businessName        String   @unique 
  
  isClient            Boolean  @default(false) 
  isSupplier          Boolean  @default(false) 
  isWarehouse         Boolean  @default(false) 
  
  clientGroup         String?  
  recognitionKeyword  String?  
  description         String?

  clientOrders        ClientOrder[]
  supplierOrders      SupplierOrder[]
  clientMappings      ClientProductMapping[]
  supplierProducts    SupplierProduct[]
}

// 1-2. 루비즈 기준 상품 (Roubiz Product)
model RoubizProduct {
  id               Int      @id @default(autoincrement())
  roubizCode       String   @unique 
  name             String   
  
  standardCost     Decimal? 
  isSet            Boolean  @default(false) 
  status           String   @default("ACTIVE")
  
  roubizOrders     RoubizOrder[]
  clientMappings   ClientProductMapping[]
  supplierProducts SupplierProduct[]
  warehouseStocks  WarehouseStock[]

  parentBundles    ProductBundle[] @relation("ParentProduct")
  childBundles     ProductBundle[] @relation("ChildProduct")
  
  supplierOrderItems SupplierOrderItem[]
}

// 1-3. 세트 구성 정보 (Bill of Materials)
model ProductBundle {
  id              Int           @id @default(autoincrement())
  parentProductId Int           
  parentProduct   RoubizProduct @relation("ParentProduct", fields: [parentProductId], references: [id])
  childProductId  Int           
  childProduct    RoubizProduct @relation("ChildProduct", fields: [childProductId], references: [id])
  quantity        Int           

  // [수정] 서비스 로직에서 upsert를 위해 이름을 명시적으로 부여
  @@unique([parentProductId, childProductId], name: "parentProductId_childProductId")
}

// ======================================================
// [2] 매핑 (Mapping)
// ======================================================

// 2-1. 고객사 상품 매핑 (Client -> Roubiz)
model ClientProductMapping {
  id                Int           @id @default(autoincrement())
  clientRoleId      Int
  clientRole        BusinessRole  @relation(fields: [clientRoleId], references: [id])
  clientProductCode String        
  clientOptionName  String        
  roubizProductId   Int
  roubizProduct     RoubizProduct @relation(fields: [roubizProductId], references: [id])
  
  // [수정] 복합 유니크 키 이름 부여
  @@unique([clientRoleId, clientProductCode, clientOptionName], name: "clientRoleId_clientProductCode_clientOptionName")
}

// 2-2. 공급처 상품 매핑 (Supplier -> Roubiz)
model SupplierProduct {
  id                  Int           @id @default(autoincrement())
  supplierId          Int
  supplier            BusinessRole  @relation(fields: [supplierId], references: [id])
  roubizProductId     Int
  roubizProduct       RoubizProduct @relation(fields: [roubizProductId], references: [id])
  supplierProductCode String?       
  supplierProductName String?       
  costPrice           Decimal       
  isPrimary           Boolean       @default(false) 
  
  // [수정] 복합 유니크 키 이름 부여
  @@unique([supplierId, roubizProductId], name: "supplierId_roubizProductId") 
}

// ======================================================
// [3] 주문의 흐름 (Input -> Hub -> Output)
// ======================================================

model ClientOrder {
  id               Int          @id @default(autoincrement())
  clientRoleId     Int
  clientRole       BusinessRole @relation(fields: [clientRoleId], references: [id])
  clientOrderNo    String   
  productCode      String   
  optionName       String?  
  quantity         Int
  salesPrice       Decimal? 
  orderDate        DateTime 
  uploadedAt       DateTime     @default(now())
  isConverted      Boolean      @default(false) 
  roubizOrders     RoubizOrder[]
}

model RoubizOrder {
  id               Int           @id @default(autoincrement())
  clientOrderId    Int
  clientOrder      ClientOrder   @relation(fields: [clientOrderId], references: [id])
  roubizOrderNo    String        @unique 
  roubizProductId  Int
  roubizProduct    RoubizProduct @relation(fields: [roubizProductId], references: [id])
  quantity         Int           
  status           String        @default("READY") 
  createdAt        DateTime      @default(now())
}

model SupplierOrder {
  id               Int           @id @default(autoincrement())
  supplierId       Int
  supplier         BusinessRole  @relation(fields: [supplierId], references: [id])
  supplierOrderNo  String        @unique 
  status           String        @default("PENDING") 
  orderedAt        DateTime      @default(now())
  items            SupplierOrderItem[]
}

model SupplierOrderItem {
  id               Int           @id @default(autoincrement())
  supplierOrderId  Int
  supplierOrder    SupplierOrder @relation(fields: [supplierOrderId], references: [id])
  roubizProductId  Int           
  roubizProduct    RoubizProduct @relation(fields: [roubizProductId], references: [id])
  quantity         Int           
  unitCost         Decimal?      
}

// ======================================================
// [4] 기타 (재고 등)
// ======================================================

model WarehouseStock {
  id              Int           @id @default(autoincrement())
  roubizProductId Int           @unique // [수정] 상품당 재고 레코드는 하나여야 함
  quantity        Int           @default(0)
  roubizProduct   RoubizProduct @relation(fields: [roubizProductId], references: [id])
}